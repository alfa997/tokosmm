<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Checkout - alfaRow SMM</title>
  <link rel="stylesheet" href="style.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600;700&family=Roboto&display=swap" rel="stylesheet">
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  
  <style>
    :root {
      --glass: rgba(255,255,255,0.45);
      --glass-border: #d4e0fa;
      --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
    }
    body {
        font-family: 'Roboto', sans-serif;
    }
    .logo, .header-right a, h2, .btn-primary, .form-group label {
        font-family: 'Montserrat', sans-serif;
    }

    /* --- Header Styles --- */
    .header-content { display: flex; align-items: center; width: 100%; justify-content: space-between; }
    .header-right { display: flex; align-items: center; gap: 0.7rem; }
    .user-greet { margin-left: 1.5rem; font-weight: 600; color: #222; background: var(--glass, rgba(255,255,255,0.45)); padding: 7px 16px; border-radius: 20px; font-size: 1.08rem; }
    .hamburger { display: none; width: 34px; height: 34px; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; z-index: 110; margin-left: 1rem; }
    .hamburger span { display: block; width: 26px; height: 3.2px; background: #222; border-radius: 3px; margin: 4px 0; transition: all 0.3s; }

    /* --- Responsive Styles --- */
    @media (max-width: 800px) {
      .header { flex-wrap: wrap; gap: 0.4rem; }
      .header-right { gap: 0.3rem; }
      .user-greet { font-size: 1rem; padding: 6px 13px; margin-left: .8rem !important; }
      .hamburger { display: flex; }
      nav#main-nav { position: fixed; top: 0; right: -100vw; width: 68vw; max-width: 320px; height: 100vh; background: var(--glass, rgba(255,255,255,0.95)); border-left: 2px solid var(--glass-border, #d4e0fa); box-shadow: -4px 0 20px rgba(30,60,130,.10); display: flex; flex-direction: column; align-items: flex-start; justify-content: flex-start; padding: 3.7rem 2.2rem 2rem 2.2rem; gap: 1.7rem; z-index: 100; transition: right 0.24s cubic-bezier(.9,.05,.22,1.1); }
      nav#main-nav.show { right: 0; }
      nav#main-nav a, nav#main-nav .btn-glass, nav#main-nav .logout-btn { margin: 0 !important; width: 100%; padding: 1rem 0; font-size: 1.09rem; border-bottom: 1px solid #ececec6b; color: #2a2a2a; background: none; border-radius: 0; box-shadow: none; text-align: left; }
    }
    
    /* --- Checkout & Form Styles --- */
    .checkout-container { max-width: 440px; margin: 2.2rem auto 0 auto; background: var(--glass, rgba(255,255,255,0.7)); border: 1.5px solid var(--glass-border, #d4e0fa); border-radius: 18px; padding: 2rem; box-shadow: var(--shadow, 0 8px 32px 0 rgba(31, 38, 135, 0.15)); backdrop-filter: blur(8px); }
    #checkout-success { display: none; text-align: center; color: #14ad34; font-weight: 700; margin: 1.7rem 0 0.5rem 0; font-size: 1.13rem; letter-spacing: .02em; }
    .form-group { margin-bottom: 1.2rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333; }
    .form-group input, .form-group textarea { width: 100%; padding: 0.8rem; border: 1px solid #ddd; border-radius: 8px; font-family: 'Roboto', sans-serif; font-size: 1rem; box-sizing: border-box; }
    .form-group textarea { min-height: 100px; resize: vertical; }
    .form-group .required { color: #ff4444; }
    .form-note { font-size: 0.85rem; color: #666; margin-top: 0.3rem; }
    .error-message { color: #ff4444; font-size: 0.85rem; margin-top: 0.3rem; display: none; }
    #data-diri-form { margin-top: 1.5rem; display: none; }
    #show-form-btn { width: 100%; margin-top: 1.1rem; }
    .btn-primary:disabled { background-color: #cccccc; cursor: not-allowed; }

    /* --- Cart Item Styles --- */
    .cart-item { display: flex; align-items: center; gap: 1.2rem; margin-bottom: 1.2rem; padding: 12px; background: rgba(255,255,255,0.5); border-radius: 12px; position: relative; }
    .cart-item img { width: 58px; height: 58px; object-fit: cover; border-radius: 14px; }
    .cart-info { flex: 1; }
    .cart-item-price { color: #0077ff; font-weight: 700; margin-top: 4px; }
    .qty-controls { display: flex; align-items: center; gap: 8px; margin-top: 5px; }
    .qty-btn { width: 26px; height: 26px; border-radius: 50%; background: #f0f0f0; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; font-size: 16px; color: #333; }
    .qty-btn:hover { background: #e0e0e0; }
    .qty-value { min-width: 20px; text-align: center; font-weight: 600; }
    .delete-btn { position: absolute; top: 8px; right: 8px; background: none; border: none; cursor: pointer; color: #ff4444; font-size: 18px; }
    .empty-cart { color: #999; margin: 1rem 0 2rem 0; text-align: center; }

    /* --- Discount & Promo Styles --- */
    .summary-line {
      display: flex;
      justify-content: space-between;
      margin-top: 0.8rem;
      font-size: 1.05rem;
    }
    .summary-line.total {
      font-weight: 700;
      font-size: 1.15rem;
      padding-top: 0.8rem;
      border-top: 1px solid #ddd;
    }
    #discount-amount {
      color: #14ad34;
      font-weight: 600;
    }
    .promo-input-wrapper {
      display: flex;
      gap: 0.5rem;
    }
    .promo-input-wrapper input {
      flex: 1;
    }
    #apply-promo-btn {
      padding: 0.7rem 1rem;
      border: none;
      background-color: #0077ff;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      font-family: 'Montserrat', sans-serif;
      font-weight: 600;
    }
    #apply-promo-btn:hover {
      background-color: #005fcc;
    }
    #apply-promo-btn:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .promo-message {
      font-size: 0.9rem;
      margin-top: 0.5rem;
      font-weight: 600;
    }
</style>
</head>
<body>

  <header class="header">
    <div class="header-content">
      <div style="display:flex; align-items:center;">
        <div class="logo">alfaRow SMM<span>.</span></div>
        <div class="hamburger" id="hamburger-menu" tabindex="0">
          <span></span><span></span><span></span>
        </div>
      </div>
      <div class="header-right" id="header-right">
        <a href="checkout.html" class="cart-link" style="margin-left:0;">
          <span class="cart-icon">🛒</span>
          <span id="cart-count">0</span>
        </a>
      </div>
    </div>
    <nav id="main-nav"></nav>
  </header>
  
  <main>
    <div class="checkout-container">
      <h2 style="text-align:center; font-weight:700; font-size:1.45rem;">Checkout</h2>
      
      <div id="cart-items">
        <p class='empty-cart'>Memuat keranjang...</p>
      </div>
      
      <div class="summary-line">Subtotal: <span id="cart-subtotal">Rp 0</span></div>
      <div class="summary-line" id="discount-row" style="display: none;">
        <span>Diskon (<strong id="applied-code"></strong>):</span>
        <span id="discount-amount"></span>
      </div>
      <div class="summary-line total">Total: <span id="cart-total">Rp 0</span></div>
      
      <button class="btn-primary" id="show-form-btn" style="width:100%;font-size:1.08rem;">Lanjutkan Checkout</button>
      
      <form id="data-diri-form" style="display: none;">
        <div class="form-group">
          <label for="email">Email <span class="required">*</span></label>
          <input type="email" id="email" required>
          <div class="error-message" id="email-error"></div>
        </div>
        <div class="form-group">
          <label for="phone">Nomor HP <span class="required">*</span></label>
          <input type="tel" id="phone" required>
          <div class="error-message" id="phone-error"></div>
        </div>
        <div class="form-group">
          <label for="message">Pesan untuk Penjual <span class="required">*</span></label>
          <textarea id="message" required minlength="15"></textarea>
          <div class="error-message" id="message-error"></div>
        </div>
        
        <div class="form-group">
          <label for="promo">Kode Promo (Opsional)</label>
          <div class="promo-input-wrapper">
            <input type="text" id="promo" placeholder="Masukkan kode promo">
            <button type="button" id="apply-promo-btn">Terapkan</button>
          </div>
          <div class="promo-message" id="promo-message"></div>
        </div>
        
        <button type="submit" class="btn-primary" style="width:100%;font-size:1.08rem;margin-top:0.5rem;">Checkout Sekarang</button>
      </form>
      
      <div id="checkout-success">Checkout berhasil! Terima kasih sudah belanja 🎉</div>
    </div>
  </main>
  
  <footer>
    <p>© 2025 <strong>alfaRow SMM</strong>. All rights reserved.</p>
  </footer>
  
  <script>
    // --- KONFIGURASI FIREBASE ---
    const firebaseConfig = {
            apiKey: "AIzaSyDEfb3zkNFU2YGxZlg59go6N-n0RQmr_ks",
            authDomain: "alfarow-multi.firebaseapp.com",
            projectId: "alfarow-multi",
            storageBucket: "alfarow-multi.appspot.com",
            messagingSenderId: "575378922898",
            appId: "1:575378922898:web:f4ef23f268aea69ad1354b",
            measurementId: "G-XEX4BZ1GQS"
        };
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    // --- AKHIR KONFIGURASI ---

    document.addEventListener("DOMContentLoaded", function() {
      
      // Listener utama untuk status otentikasi
      auth.onAuthStateChanged(function(user) {
        if (user) {
          // Pengguna sudah login, jalankan semua fungsi aplikasi
          initializeApp(user);
        } else {
          // Pengguna tidak login, paksa kembali ke halaman login
          // Ini adalah "penjaga gerbang" yang sebenarnya
          window.location.href = 'login.html';
        }
      });
    });

    // Fungsi utama aplikasi yang berjalan SETELAH login terverifikasi
    function initializeApp(user) {
      
      // --- FUNGSI-FUNGSI PEMBANTU ---
      const toRupiah = (angka) => 'Rp ' + Math.round(angka).toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
      const getCart = () => JSON.parse(localStorage.getItem('cart') || '[]');
      const saveCart = (cart) => localStorage.setItem('cart', JSON.stringify(cart));
      
      const PROMO_CODES = {
        'HEMAT10': { type: 'percentage', value: 10 },
        'POTONG5K': { type: 'fixed', value: 5000 },
      };
      
      let appliedDiscount = { code: null, amount: 0 };
      
      // --- INISIALISASI TAMPILAN (HEADER, NAV, DLL) ---
      function initHeaderAndNav() {
        const headerRight = document.getElementById("header-right");
        const username = user.displayName || user.email.split('@')[0];

        // Hapus sapaan lama jika ada, lalu buat yang baru
        const oldGreet = headerRight.querySelector('.user-greet');
        if (oldGreet) oldGreet.remove();
        
        const userSpan = document.createElement("span");
        userSpan.className = "user-greet";
        userSpan.textContent = `Hi, ${username}`;
        headerRight.appendChild(userSpan);
        
        const hamburger = document.getElementById("hamburger-menu");
        const nav = document.getElementById("main-nav");
        nav.innerHTML = ""; // Kosongkan menu sebelum mengisi
        
        const navLinks = [
            { href: "index.html", text: "Home" },
            { href: "index.html#produk", text: "Produk" },
            { href: "promo.html", text: "Promo" }
        ];
        navLinks.forEach(linkInfo => {
            const link = document.createElement('a');
            link.href = linkInfo.href;
            link.textContent = linkInfo.text;
            nav.appendChild(link);
        });

        if (localStorage.getItem("username") === "alfa") {
            const adminMenu = document.createElement('a');
            adminMenu.href = "admin.html";
            adminMenu.textContent = "Admin";
            nav.appendChild(adminMenu);
        }

        const logoutBtn = document.createElement("a");
        logoutBtn.href = "#";
        logoutBtn.className = "logout-btn";
        logoutBtn.textContent = "Logout";
        logoutBtn.onclick = (e) => {
            e.preventDefault();
            auth.signOut().then(() => {
                localStorage.removeItem("isLogin"); // Best practice untuk membersihkan
                localStorage.removeItem("username");
                window.location.href = "login.html";
            });
        };
        nav.appendChild(logoutBtn);
        
        hamburger.addEventListener("click", () => nav.classList.toggle("show"));
        document.addEventListener("click", (e) => {
            if (window.innerWidth <= 800 && !nav.contains(e.target) && !hamburger.contains(e.target)) {
                nav.classList.remove("show");
            }
        });
      }

      // --- FUNGSI-FUNGSI KERANJANG BELANJA ---
      function updateCartCount() {
        const totalItems = getCart().reduce((total, item) => total + item.qty, 0);
        document.getElementById('cart-count').textContent = totalItems;
      }
      
      function updateTotals() {
        const cart = getCart();
        const subtotal = cart.reduce((total, item) => total + (item.price * item.qty), 0);
        
        // Hitung ulang diskon berdasarkan subtotal saat ini
        if (appliedDiscount.code) {
            const codeData = PROMO_CODES[appliedDiscount.code];
            if (codeData.type === 'percentage') {
                appliedDiscount.amount = (subtotal * codeData.value) / 100;
            } else {
                appliedDiscount.amount = codeData.value;
            }
        } else {
            appliedDiscount.amount = 0;
        }

        const total = Math.max(0, subtotal - appliedDiscount.amount);
        
        document.getElementById('cart-subtotal').textContent = toRupiah(subtotal);
        document.getElementById('cart-total').textContent = toRupiah(total);
        
        const discountRow = document.getElementById('discount-row');
        if (appliedDiscount.amount > 0) {
            document.getElementById('applied-code').textContent = appliedDiscount.code;
            document.getElementById('discount-amount').textContent = `- ${toRupiah(appliedDiscount.amount)}`;
            discountRow.style.display = 'flex';
        } else {
            discountRow.style.display = 'none';
        }
      }

      function renderCart() {
        const cart = getCart();
        const cartItemsEl = document.getElementById('cart-items');
        const showFormBtn = document.getElementById('show-form-btn');
        cartItemsEl.innerHTML = "";
        
        if (cart.length === 0) {
            cartItemsEl.innerHTML = "<p class='empty-cart'>Keranjang Anda masih kosong.</p>";
            showFormBtn.disabled = true;
            document.getElementById('data-diri-form').style.display = 'none';
            showFormBtn.style.display = 'block';
        } else {
            cart.forEach((item, index) => {
                const itemHtml = `
                    <div class="cart-item" data-id="${item.id}">
                        <button class="delete-btn" data-index="${index}" title="Hapus item">🗑️</button>
                        <img src="${item.img}" alt="${item.name}">
                        <div class="cart-info">
                            <div>${item.name}</div>
                            <div class="qty-controls">
                                <button class="qty-btn minus" data-index="${index}">-</button>
                                <span class="qty-value">${item.qty}</span>
                                <button class="qty-btn plus" data-index="${index}">+</button>
                            </div>
                            <div class="cart-item-price">${toRupiah(item.price * item.qty)}</div>
                        </div>
                    </div>`;
                cartItemsEl.innerHTML += itemHtml;
            });
            showFormBtn.disabled = false;
        }
        updateCartCount();
        updateTotals();
      }
      
      function handleCartActions(e) {
        const target = e.target;
        const index = parseInt(target.dataset.index);
        
        let cart = getCart();

        if (target.classList.contains('delete-btn')) {
            cart.splice(index, 1);
        }
        if (target.classList.contains('plus')) {
            cart[index].qty += 1;
        }
        if (target.classList.contains('minus')) {
            cart[index].qty -= 1;
            if (cart[index].qty <= 0) {
                cart.splice(index, 1);
            }
        }
        
        saveCart(cart);
        renderCart();
      }
      
      function applyPromo() {
          const promoInput = document.getElementById('promo');
          const promoBtn = document.getElementById('apply-promo-btn');
          const messageEl = document.getElementById('promo-message');
          const code = promoInput.value.toUpperCase().trim();

          if (PROMO_CODES[code]) {
              appliedDiscount.code = code;
              messageEl.textContent = `Kode "${code}" berhasil diterapkan!`;
              messageEl.style.color = 'green';
              promoInput.disabled = true;
              promoBtn.disabled = true;
              promoBtn.textContent = 'OK';
          } else {
              appliedDiscount.code = null;
              messageEl.textContent = 'Kode promo tidak valid.';
              messageEl.style.color = 'red';
          }
          updateTotals(); // Hitung ulang total setelah promo
      }

      // --- FUNGSI CHECKOUT ---
      function handleCheckout(e) {
        e.preventDefault();
        
        const emailEl = document.getElementById('email');
        const phoneEl = document.getElementById('phone');
        const messageEl = document.getElementById('message');
        let isValid = true;
        
        // Validasi
        if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailEl.value)) {
            document.getElementById('email-error').textContent = 'Harap masukkan email yang valid.';
            isValid = false;
        } else { document.getElementById('email-error').textContent = ''; }

        if (!/^[0-9]{10,15}$/.test(phoneEl.value)) {
            document.getElementById('phone-error').textContent = 'Harap masukkan nomor HP valid (10-15 digit).';
            isValid = false;
        } else { document.getElementById('phone-error').textContent = ''; }

        if (messageEl.value.length < 15) {
            document.getElementById('message-error').textContent = 'Pesan harus minimal 15 karakter.';
            isValid = false;
        } else { document.getElementById('message-error').textContent = ''; }

        if (!isValid) return;

        const cart = getCart();
        if (cart.length === 0) {
            alert("Keranjang Anda kosong!");
            return;
        }

        const orderId = '19876' + (Math.floor(Math.random() * 900) + 100);
        const subtotal = cart.reduce((total, item) => total + (item.price * item.qty), 0);
        const finalTotal = Math.max(0, subtotal - appliedDiscount.amount);

        let whatsappMessage = "*Order Tokonline*\n\n";
        whatsappMessage += "*Daftar Produk:*\n";
        cart.forEach((item, idx) => {
            whatsappMessage += `${idx + 1}. *(ID: ${orderId})* ${item.name} (x${item.qty}) = ${toRupiah(item.price * item.qty)}\n`;
        });
        
        whatsappMessage += `\n*Subtotal: ${toRupiah(subtotal)}*`;
        if (appliedDiscount.amount > 0) {
            whatsappMessage += `\n*Diskon (${appliedDiscount.code}): -${toRupiah(appliedDiscount.amount)}*`;
        }
        whatsappMessage += `\n*Total Akhir: ${toRupiah(finalTotal)}*\n`;
        whatsappMessage += `\nSilakan lakukan pembayaran ke:\nalfarow.biz.id/Qris\n`;
        whatsappMessage += `\n*Data Pembeli:*\n`;
        whatsappMessage += `Nama: ${user.displayName || user.email.split('@')[0]}\n`;
        whatsappMessage += `Email: ${emailEl.value}\n`;
        whatsappMessage += `No. HP: ${phoneEl.value}\n`;
        whatsappMessage += `Pesan: ${messageEl.value}\n\n`;
        whatsappMessage += `Lakukan pembayaran sesuai nominal agar pesanan Anda diproses otomatis.\n`;
        whatsappMessage += `Terima kasih!`;

        const waNo = "6282129825028";
        const url = `https://wa.me/${waNo}?text=${encodeURIComponent(whatsappMessage)}`;
        
        localStorage.removeItem('cart');
        document.getElementById('checkout-success').style.display = 'block';
        document.getElementById('data-diri-form').style.display = 'none';
        
        setTimeout(() => {
            window.location.href = url;
            // Setelah dialihkan, render ulang keranjang (yang sekarang kosong)
            renderCart();
        }, 2500);
      }
      
      // --- EVENT LISTENERS ---
      document.getElementById('cart-items').addEventListener('click', handleCartActions);
      document.getElementById('show-form-btn').addEventListener('click', () => {
          document.getElementById('data-diri-form').style.display = 'block';
          document.getElementById('show-form-btn').style.display = 'none';
      });
      document.getElementById('apply-promo-btn').addEventListener('click', applyPromo);
      document.getElementById('data-diri-form').addEventListener('submit', handleCheckout);

      // --- EKSEKUSI AWAL ---
      initHeaderAndNav();
      renderCart();
    }
  </script>
</body>
</html>
